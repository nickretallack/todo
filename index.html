<!doctype html>
<html>
<head>
<style type="text/css">
body {font-family:helvetica, arial;}
#list_panel, #details_panel {display:inline-block; width:40%; vertical-align:top;}
.auto_complete {border:1px solid #aaa; padding:5px;}
li {list-style:none;}
ul {margin:0; padding:0;}
h1,h2,h3 { margin:0;}
h3 {color:#aaa;}
input[type=text] {font-size:inherit; font-family:inherit; width:20em;}
/*    #focused .focus {display:none;}
    .before, .after {display:none;}
*//*        .editing .before, .editing .after {display:inline;}*/
</style>
<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>-->
<script type="text/javascript" src="/script/jquery.js"></script>
<script type="text/javascript" src="resig-templates.js"></script>
<script type="text/javascript" src="gears_init.js"></script>
<script type="text/javascript" src="util.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="underscore.js"></script>

<script type="text/javascript" src="jquery-autocomplete/jquery.autocomplete.js"></script>
<link rel="stylesheet" type="text/css" href="jquery-autocomplete/jquery.autocomplete.js">


<script type="text/javascript">
// TODO: transfer out of this database, and stop using hyphens, I guess
var current_database = 'todo-list'

// TODO: check if gears exists before breaking the script
var db = google.gears.factory.create('beta.database');
db.open(current_database);

// TODO: figure out how to do this conditionally
// db.execute('create virtual table item using fts2(text, note)')
// db.execute('create table prerequisite (before_id integer, after_id integer)')
// NOTES: could do some schema versioning stuff later on

</script>

<script type="text/javascript">
var focused_item_id
var available_mode = false


$(function(){
    $('#insert-main-list').html(tmpl('entry_list_template', {name:"main", 
        flavor_text:"I should...", list:[]}))
    //     
    // var list = $('#main-list')
    // var input = $('#main-input')

    // TODO: make this more general?
    // resurrect items

    
    $('.focus').live('click', function(){
        var item = $(this).parent('li')
        var id = item.attr('data-id')
        var text = item.find('.text').text()
        focus_item(id, text)
    })


    //////////////////////////////////////////////////
    // Reduce Repetition
    $('#main-input').keydown(function(event){
        if (event.which == keys.enter) {
            entered_item($(this))
        }

        auto_search($(this))
    })

    $('#before-input').live('keydown', function(event){
        if (event.which == keys.enter) {
            before_enter($(this))
        }
        auto_search($(this))
    })

    $('#after-input').live('keydown', function(event){
        if (event.which == keys.enter) {
            after_enter($(this))
        }
        auto_search($(this))
    })


    // TODO: reduce to a loop
    $('#before .autocomplete li').live('click', function(){
        console.debug("clicked it")
        autocomplete_click($(this), before_enter)
    })

    $('#main .autocomplete li').live('click', function(){
        autocomplete_click($(this), entered_item)
    })

    $('#after .autocomplete li').live('click', function(){
        autocomplete_click($(this), after_enter)
    })


    $('#filter #all').click(function(event){
        show_all_items()
    })

    $('#filter #available').click(function(event){
        show_available_items()
    })

    

    ///////////////////////////////////////////////////
    
    // // Use these later
    // $('.done').live('click', function(){
    //     moveto(this, '#done')
    // })
    // 
    // $('.do').live('click', function(){
    //     moveto(this, '#doing')
    // })

    // TODO: implement these with a template instead of clearing html
    function show_all_items(){
        var available_mode = false
        $('#main-list').html('')
        query_iterate( db, 'select text, rowid from item', [], function(row){
            add_to_list($('#main-list'), row.text, row.rowid)
        })
    }
    
    function show_available_items(){
        var available_mode = true
        $('#main-list').html('')
        query_iterate( db, "select item.rowid, item.text from item \
                left outer join prerequisite on prerequisite.after_id = item.rowid\
                where prerequisite.before_id is null", [], 
            function(row){
                add_to_list($('#main-list'), row.text, row.rowid)
            }
        )        
    }
    
    
    
    show_all_items()
})


</script>

<script type="text/html" id="entry_list_template">
<div class="list" id="<%= name %>">
<h3><%= flavor_text %></h3>
<input type="text" id="<%= name %>-input" class="input">
<ul class="autocomplete"></ul>

<ul id="<%= name %>-list">
    <% for ( var i = 0; i < list.length; i++ ) { %>
        <%= tmpl('todo_item_template', list[i]) %>
    <% } %>
</ul>
</div>
</script>


<script type="text/html" id="todo_item_template">
<li data-id="<%= rowid %>">
    <input type="radio" name="focus" class="focus" id="item-<%= text %>">
    <label class="text" for="item-<%= text %>"><%= text %></label>
    <!-- <button class="focus">Focus</button>
    <button class="done">Done</button>
    <button class="do">Do</button>
    <button class="before">before</button>
    <button class="after">after</button>-->
</script>

<script type="text/html" id="item_details_template">
<h2><%= text %></h2>
<%= tmpl('entry_list_template', {name:"before", flavor_text:"Before I can do this, I need to...", list:before }) %>
<%= tmpl('entry_list_template', {name:"after", flavor_text:"After I finish this, I can...", list:after }) %>
</ul>

</script>

<script type="text/html" id="list_items_template">
<% for (var i = 0; i < list.length; i++) { %>
    <li><%= list[i] %>
<% } %>
</script>


</head>
<body>
    <div id="list_panel">
        <ul id="focused"></ul>

        <ul id="filter">
            <label for="all">       <input name="filter" type="radio" id="all" checked  >All</label>
            <label for="available"> <input name="filter" type="radio" id="available"    >Available</label>
        </ul>
        
        <div id="insert-main-list"></div>

        <!-- <h2>On Your Plate</h2>
        <ul id="doing"></ul>

        <h2>Done</h2>
        <ul id="done"></ul> -->
    </div>

    <div id="details_panel"></div>


</body>
</html>

