<!doctype html>
<html>
<head>
<style type="text/css">
body {font-family:helvetica, arial;}
#list_panel, #details_panel {display:inline-block; width:40%; vertical-align:top;}
/*#before-list input[type=radio] {display:none;}*/
.list {margin:20px 0;}
.autocomplete { padding:5px; color:blue; cursor:pointer;}
li {list-style:none;}
ul {margin:0; padding:0;}
h1,h2,h3 { margin:0;}
h3 {color:#aaa;}
h2 button {display:inline-block; vertical-align:20%;} 
input[type=text] {font-size:inherit; font-family:inherit; width:20em;}
/*    #focused .focus {display:none;}
    .before, .after {display:none;}
*//*        .editing .before, .editing .after {display:inline;}*/
</style>
<!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.js"></script>-->
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resig-templates.js"></script>
<script type="text/javascript" src="gears_init.js"></script>
<script type="text/javascript" src="util.js"></script>
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="underscore.js"></script>


<script type="text/javascript">
var current_database = 'todo-list'
var max_autocomplete_results = 10

// TODO: check if gears exists before breaking the script
var db = google.gears.factory.create('beta.database');
// db.open(current_database);
// db.remove()
db.open(current_database);

db.execute('create table if not exists schema_version (version integer)')
var rowset = db.execute('select version from schema_version order by version desc')
// TODO: write a helper for this use case where only one column is selected.
// and one for the case where only the first result is needed as well.
var version = rowset.field(0)
if (!version) {
    db.execute('create virtual table item using fts2(text, note)')
    db.execute('create table item_details (created_date datetime, start_date datetime, due_date datetime, \
        done_date datetime, done_reason varchar)')
    // done_reason should be one of (manual, dropped, prerequisite, alternative)
    // More words if it was caused by a tree action. e.g. 

    db.execute('create table prerequisite (before_id integer, after_id integer)')
    db.execute('create table simultaneous (item_id integer, related_item_id integer)')
    // Simultaneous items are like an undirected graph.  I'm implementing them as directed edges for simplicity
    // Every time I create one edge, I should create its complement edge as well.  Same goes for deleting.

    db.execute('create table alternative (item_id integer, group_id integer)')
    // Alternative actions are like an abstract group.  If you associate with one, you associate with all of them.

    db.execute('create virtual table equipment using fts2(name)')
    db.execute('create table equipment_needed (item_id integer, equipment_id integer)')

    db.execute('insert into schema_version (version) values (1)')
}

// NOTE: next time I want to alter stuff, just add an "if version < X" clause here.
</script>

<script type="text/javascript">
var focused_item_id
var available_mode = false


$(function(){
    $('#insert-main-list').html(tmpl('editable_list_template', {name:"main", 
        flavor_text:"I should...", list:[]}))
    //     
    // var list = $('#main-list')
    // var input = $('#main-input')

    // TODO: make this more general?
    // resurrect items

    
    $('.focus').live('click', function(){
        var item = $(this).parent('li')
        var id = item.attr('data-id')
        var text = item.find('.text').text()
        focus_item(id, text)
    })


    //////////////////////////////////////////////////
    // Reduce Repetition
    $('#main-input').keydown(function(event){
        if (event.which == keys.enter) {
            entered_item($(this))
        }

        auto_search($(this))
    })

    $('#before-input').live('keydown', function(event){
        if (event.which == keys.enter) {
            before_enter($(this))
        }
        auto_search($(this))
    })

    $('#after-input').live('keydown', function(event){
        if (event.which == keys.enter) {
            after_enter($(this))
        }
        auto_search($(this))
    })


    // TODO: reduce to a loop
    $('#before .autocomplete li').live('click', function(){
        autocomplete_click($(this), before_enter)
    })

    $('#main .autocomplete li').live('click', function(){
        autocomplete_click($(this), entered_item)
    })

    $('#after .autocomplete li').live('click', function(){
        autocomplete_click($(this), after_enter)
    })


    $('#filter #all').click(function(event){
        show_all_items()
    })

    $('#filter #available').click(function(event){
        show_available_items()
    })

    

    ///////////////////////////////////////////////////
    
    $('.done').live('click', function(){
        var itemnode = $(this).parents('.item')
        var item_id = itemnode.attr('data-id')
        // console.debug(item_id)
        // db.execute('')
        // moveto(this, '#done')
    })
    
    // // Use this later
    // $('.do').live('click', function(){
    //     moveto(this, '#doing')
    // })

    // TODO: implement these with a template instead of clearing html
    function show_all_items(){
        available_mode = false
        $('#main-list').html('')
        query_iterate( db, 'select text, rowid from item', [], function(row){
            add_to_list($('#main-list'), row.text, row.rowid)
        })
    }
    
    function show_available_items(){
        available_mode = true
        $('#main-list').html('')
        query_iterate( db, "select item.rowid, item.text from item \
                left outer join prerequisite on prerequisite.after_id = item.rowid\
                where prerequisite.before_id is null", [], 
            function(row){
                add_to_list($('#main-list'), row.text, row.rowid)
            }
        )        
    }

    
    show_available_items()
})


</script>

<script type="text/html" id="editable_list_template">
<div class="list" id="<%= name %>">
<h3><%= flavor_text %></h3>
<input type="text" id="<%= name %>-input" class="input">
<ul class="autocomplete"></ul>

<ul id="<%= name %>-list">
    <% for ( var i = 0; i < list.length; i++ ) { %>
        <%= tmpl('item_template', list[i]) %>
    <% } %>
</ul>
</div>
</script>

<script type="text/html" id="item_template">
<li data-id="<%= rowid %>">
    <input type="radio" name="focus" class="focus" id="item-<%= text %>">
    <label class="text" for="item-<%= text %>"><%= text %></label>
    <!-- <button class="focus">Focus</button>
    <button class="done">Done</button>
    <button class="do">Do</button>
    <button class="before">before</button>
    <button class="after">after</button>-->
</script>

<!-- TODO: stop using rowid here and make it item_id -->
<script type="text/html" id="item_details_template">
<h2 data-id="<%= rowid %>" class="item"><%= text %>
    <button class="done">Done</button>
</h2>
<%= tmpl('editable_list_template', {name:"before", flavor_text:"But first I should...", list:before }) %>
<%= tmpl('editable_list_template', {name:"after", flavor_text:"After that I can...", list:after }) %>
</ul>

</script>

<script type="text/html" id="list_items_template">
<% for (var i = 0; i < list.length; i++) { %>
    <li><%= list[i] %>
<% } %>
</script>


</head>
<body>
    <div id="list_panel">
        <ul id="focused"></ul>

        <ul id="filter">
            <label for="available"> <input name="filter" type="radio" id="available" checked>Available</label>
            <label for="unfinished"> <input name="filter" type="radio" id="unfinished">Unfinished</label>
            <label for="finished"> <input name="filter" type="radio" id="finished">Finished</label>
            <label for="all">       <input name="filter" type="radio" id="all"   >All</label>
        </ul>
        
        <div id="insert-main-list"></div>

        <!-- <h2>On Your Plate</h2>
        <ul id="doing"></ul>

        <h2>Done</h2>
        <ul id="done"></ul> -->
    </div>

    <div id="details_panel"></div>


</body>
</html>

